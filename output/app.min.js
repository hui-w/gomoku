function App(){var a=this;this.game=new Game();this.game.onChange=function(){a.redraw()};this.width=0;this.height=0;this.cellSize=0;this.canvas=null;this.context=null;this.init()}App.prototype={init:function(){var a=this;this.width=document.documentElement.clientWidth;this.height=document.documentElement.clientHeight;this.render()},render:function(){var b=this;var a=document.body;var d=a.createChild("div",{id:"app-wrapper",style:"padding: "+Config.Canvas.margin+"px"});this.canvas=d.createChild("canvas",{id:"app-canvas",width:0,height:0});if(typeof G_vmlCanvasManager!="undefined"){this.canvas=G_vmlCanvasManager.initElement(this.canvas)}this.context=this.canvas.getContext("2d");this.handleMouseEvent=function(f){b.handleMouse(f,b)};this.canvas.addEventListener("mousedown",this.handleMouseEvent,false);this.canvas.addEventListener("mousemove",this.handleMouseEvent,false);this.canvas.addEventListener("mouseup",this.handleMouseEvent,false);this.handleTouchEvent=function(f){b.handleTouch(f,b)};this.canvas.addEventListener("touchstart",this.handleTouchEvent,false);this.canvas.addEventListener("touchend",this.handleTouchEvent,false);this.canvas.addEventListener("touchmove",this.handleTouchEvent,false);this.resizeCanvas();function c(){var f=document.documentElement.clientWidth;var e=document.documentElement.clientHeight;if(f!=b.width||e!=b.height){b.width=f;b.height=e;b.resizeCanvas()}}setInterval(c,200)},resizeCanvas:function(){this.canvas.width=this.width-Config.Canvas.margin*2;this.canvas.height=this.height-Config.Canvas.margin*2;var a=(this.canvas.width>this.canvas.height?this.canvas.height:this.canvas.width)-Config.Canvas.padding*2;this.game.setPaintingArea(Config.Canvas.padding,Config.Canvas.padding,a);this.redraw()},redraw:function(){this.canvas.width=this.canvas.width;this.canvas.height=this.canvas.height;this.context.save();this.context.fillStyle=Config.Canvas.fill;this.context.fillRect(0,0,this.canvas.width,this.canvas.height);this.context.restore();this.game.draw(this.context);console.log("- canvas redraw")},handleMouse:function(b,a){switch(b.type){case"mousedown":a.capture(b);break;case"mousemove":a.move(b);break;case"mouseup":a.release(b);break}},handleTouch:function(b,a){b.preventDefault();switch(b.type){case"touchstart":if(b.touches.length==1){a.capture(b.targetTouches[0])}else{if(b.touches.length==2){}}break;case"touchend":if(b.changedTouches.length==1){a.release(b.changedTouches[0])}break;case"touchmove":if(b.changedTouches.length==1){a.move(b.changedTouches[0])}else{if(b.touches.length==2){}}break}},capture:function(a){var b=this.getEventPosition(a);this.game.onCapture(b.left,b.top)},release:function(a){var b=this.getEventPosition(a);this.game.onRelease(b.left,b.top)},move:function(a){var b=this.getEventPosition(a);this.game.onMove(b.left,b.top)},getEventPosition:function(a){return{left:a.pageX-this.canvas.offsetLeft,top:a.pageY-this.canvas.offsetTop}}};var app=null;addEventListener("load",function(){app=new App()});function $(){var c=new Array();for(var b=0;b<arguments.length;b++){var a=arguments[b];if(typeof a=="string"){a=document.getElementById(a)}if(arguments.length==1){return a}c.push(a)}return c}function rand(a,b){return Math.floor(Math.random()*(b-a+1))+a}Array.prototype.removeAt=function(a){if(isNaN(a)||a>this.length){return false}this.splice(a,1)};Element.prototype.createChild=function(a,c,d){var b=document.createElement(a);this.appendChild(b);if(c){for(key in c){b.setAttribute(key,c[key])}}if(d){b.innerHTML=d}return b};Element.prototype.hasClassName=function(b){return new RegExp("(?:^|\\s+)"+b+"(?:\\s+|$)").test(this.className)};Element.prototype.addClassName=function(b){if(!this.hasClassName(b)){this.className=[this.className,b].join(" ")}};Element.prototype.removeClassName=function(c){if(this.hasClassName(c)){var d=this.className;this.className=d.replace(new RegExp("(?:^|\\s+)"+c+"(?:\\s+|$)","g")," ")}};var canvasPrototype=window.CanvasRenderingContext2D&&CanvasRenderingContext2D.prototype;canvasPrototype.antiFuzzyLine=function(b,d,a,c){if(this.lineWidth%2==1){b-=0.5;d-=0.5;a-=0.5;c-=0.5}this.moveTo(b,d);this.lineTo(a,c)};canvasPrototype.fillTextEx=function(e,b,g,c,f){this.save();var a=b;if(c!="left"){var d=this.measureText(e).width;if(c=="center"){a-=d/2}else{if(c=="right"){a-=d}}}this.textBaseline=f;this.fillText(e,a,g);this.restore()};var Config={Canvas:{margin:0,padding:10,fill:"RGBA(222, 237, 247, 0.3)"},Board:{size:15,stroke:"RGBA(200, 200, 200, 0.5)"},Selected:{stroke:"RGBA(255, 0, 0, 0.5)",dragSensitive:3}};function Game(){this.left=0;this.top=0;this.size=0;this.right=0;this.bottom=0;this.unitSize=0;this.halfSize=0;this.isBlack=true;this.stones=[];this.capturedPos=null;this.dragOffset=null;this.selectedCell=null;this.onChange=null}Game.prototype={init:function(){this.stones=[]},setPaintingArea:function(c,b,a){this.left=c;this.top=b;this.unitSize=Math.floor(a/Config.Board.size);this.halfSize=Math.floor(a/Config.Board.size/2);this.right=c+this.unitSize*Config.Board.size-1;this.bottom=b+this.unitSize*Config.Board.size-1},draw:function(a){this.drawChessboard(a);this.drawCells(a);this.drawHighlight(a)},drawChessboard:function(b){var c={left:this.left+this.halfSize,top:this.top+this.halfSize,right:this.right-this.halfSize,bottom:this.bottom-this.halfSize};b.save();b.beginPath();for(var a=0;a<Config.Board.size;a++){b.antiFuzzyLine(c.left,c.top+this.unitSize*a,c.right,c.top+this.unitSize*a);b.antiFuzzyLine(c.left+this.unitSize*a,c.top,c.left+this.unitSize*a,c.bottom)}b.lineWidth=1;b.strokeStyle=Config.Board.stroke;b.stroke();b.restore()},drawCells:function(a){for(var f=0;f<this.stones.length;f++){var k=this.stones[f].x;var g=this.stones[f].y;var b=this.stones[f].isBlack;var c=this.left+k*this.unitSize;var h=this.top+g*this.unitSize;var e=c+this.halfSize;var d=h+this.halfSize;a.beginPath();a.arc(e,d,this.halfSize-2,0,2*Math.PI);a.closePath();var j=a.createRadialGradient(e+2,d-2,this.halfSize-2,e+2,d-2,0);if(!b){j.addColorStop(0,"#D1D1D1");j.addColorStop(1,"#F9F9F9")}else{j.addColorStop(0,"#0A0A0A");j.addColorStop(1,"#636766")}a.fillStyle=j;a.fill()}},drawHighlight:function(c){if(this.selectedCell){var f=this.left+this.selectedCell.x*this.unitSize;var e=this.top+this.selectedCell.y*this.unitSize;var b=f+this.unitSize;var a=e+this.unitSize;var d=Math.floor(this.unitSize/4);c.save();c.beginPath();c.moveTo(f,e+d);c.lineTo(f,e);c.lineTo(f+d,e);c.moveTo(b-d,e);c.lineTo(b,e);c.lineTo(b,e+d);c.moveTo(b,a-d);c.lineTo(b,a);c.lineTo(b-d,a);c.moveTo(f+d,a);c.lineTo(f,a);c.lineTo(f,a-d);c.lineWidth=2;c.strokeStyle=Config.Selected.stroke;c.stroke();c.restore()}},onCapture:function(b,a){this.capturedPos={left:b,top:a};this.setSelectedCell(b,a)},onMove:function(b,a){if(!this.capturedPos){return}if(!this.dragOffset){var c=Math.pow(b-this.capturedPos.left,2)+Math.pow(a-this.capturedPos.top,2);if(c>=Config.Selected.dragSensitive*Math.pow(this.unitSize,2)){this.dragOffset={left:b-this.capturedPos.left,top:a-this.capturedPos.top}}}else{this.setSelectedCell(b-this.dragOffset.left,a-this.dragOffset.top)}},setSelectedCell:function(e,d){var b=this.selectedCell?this.selectedCell.x:null;var a=this.selectedCell?this.selectedCell.y:null;if(e<this.left||e>this.right||d<this.top||d>this.bottom){this.selectedCell=null}else{this.selectedCell=this.posToCell(e,d)}var f=this.selectedCell?this.selectedCell.x:null;var c=this.selectedCell?this.selectedCell.y:null;if(f!=b||c!=a){this.triggerChange()}},onRelease:function(b,a){this.capturedPos=null;this.dragOffset=null;if(this.selectedCell&&!this.hasStone(this.selectedCell.x,this.selectedCell.y)){this.stones.push({x:this.selectedCell.x,y:this.selectedCell.y,isBlack:this.isBlack});this.isBlack=!this.isBlack;this.triggerChange()}},posToCell:function(b,a){return{x:Math.floor((b-this.left)/this.unitSize),y:Math.floor((a-this.top)/this.unitSize)}},hasStone:function(a,c){for(var b=0;b<this.stones.length;b++){if(a===this.stones[b].x&&c===this.stones[b].y){return true}}return false},triggerChange:function(){if(typeof this.onChange=="function"){this.onChange()}}};